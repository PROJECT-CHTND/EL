groups:
  - name: el-agent.rules
    interval: 30s
    rules:
      # QCheck failure rate (failed_qcheck / total_qgen)
      - alert: QCheckFailureRateHigh
        expr: |
          (
            sum(rate(qcheck_failed_total[5m]))
            /
            clamp_min(sum(rate(qgen_total[5m])), 1)
          ) > 0.15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "QCheck failure rate is high (> 15% over 5m)"
          description: "Stage07 QCheck is failing frequently. Check prompts, thresholds, or LLM health."

      # Duplicate question rate (slot_duplicate_rate gauge)
      - alert: DuplicateQuestionRateHigh
        expr: slot_duplicate_rate{pipeline_stage="stage07_qcheck"} > 0.20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Duplicate question rate is high (> 20%)"
          description: "Many generated questions are being filtered as duplicates in Stage07. Review SlotRegistry and qgen prompts."

      # Turn latency p90 / p99 thresholds
      - alert: TurnLatencyHighP90
        expr: |
          histogram_quantile(
            0.9,
            sum(rate(turn_latency_seconds_bucket[5m])) by (le)
          ) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Turn latency p90 > 5s"
          description: "End-to-end turn latency (p90) exceeds 5 seconds. Check LLM/Retrieval/Discord latencies."

      - alert: TurnLatencyHighP99
        expr: |
          histogram_quantile(
            0.99,
            sum(rate(turn_latency_seconds_bucket[5m])) by (le)
          ) > 10
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Turn latency p99 > 10s"
          description: "End-to-end turn latency (p99) exceeds 10 seconds. Users may experience severe delays."

      # Metrics target down (no scrape)
      - alert: ElAgentMetricsDown
        expr: up{job="el-agent"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "el-agent metrics target is down"
          description: "Prometheus cannot scrape el-agent /metrics endpoint. Check METRICS_PORT and service status."


